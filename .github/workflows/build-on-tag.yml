name: Build Debian Package On Tag

on:
  push:
    tags:
      - "*"
  repository_dispatch:
    types:
      - upstream_tag_synced
  workflow_dispatch:
    inputs:
      tag:
        description: Tag to build (required for manual runs)
        required: true
        type: string

permissions:
  contents: read

concurrency:
  group: build-on-tag-${{ github.event.client_payload.tag || github.ref_name || github.event.inputs.tag || github.run_id }}
  cancel-in-progress: false

jobs:
  build-deb:
    runs-on: ubuntu-latest

    steps:
      - name: Resolve build parameters
        id: params
        env:
          EVENT_NAME: ${{ github.event_name }}
          PUSH_TAG: ${{ github.ref_name }}
          DISPATCH_TAG: ${{ github.event.client_payload.tag }}
          INPUT_TAG: ${{ github.event.inputs.tag }}
        run: |
          set -euo pipefail

          tag=""
          if [[ "${EVENT_NAME}" == "push" ]]; then
            tag="${PUSH_TAG}"
          elif [[ "${EVENT_NAME}" == "repository_dispatch" ]]; then
            tag="${DISPATCH_TAG}"
          else
            tag="${INPUT_TAG}"
          fi

          if [[ -z "${tag}" ]]; then
            echo "Tag could not be resolved for this run." >&2
            exit 1
          fi

          connections_limit="100"
          connections_file=""
          build_command="git clone --depth=1 https://github.com/ONLYOFFICE/build_tools.git /tmp/build_tools && cd /tmp/build_tools/tools/linux && ./automate.py server"
          package_command="cd /tmp/build_tools && python3 make_package.py -P linux_x86_64 -T server_community"

          echo "tag=${tag}" >> "${GITHUB_OUTPUT}"
          echo "connections_limit=${connections_limit}" >> "${GITHUB_OUTPUT}"
          echo "connections_file=${connections_file}" >> "${GITHUB_OUTPUT}"

          {
            echo "build_command<<EOF"
            echo "${build_command}"
            echo "EOF"
          } >> "${GITHUB_OUTPUT}"

          {
            echo "package_command<<EOF"
            echo "${package_command}"
            echo "EOF"
          } >> "${GITHUB_OUTPUT}"

      - name: Checkout tag with submodules
        uses: actions/checkout@v4
        with:
          ref: refs/tags/${{ steps.params.outputs.tag }}
          fetch-depth: 0
          submodules: false
          token: ${{ github.token }}

      - name: Configure submodules to upstream sources
        run: |
          set -euo pipefail

          while read -r key url; do
            if [[ "${url}" == ../* ]]; then
              repo="${url#../}"
              git config -f .gitmodules "${key}" "https://github.com/ONLYOFFICE/${repo}"
            fi
          done < <(git config -f .gitmodules --get-regexp '^submodule\..*\.url$' || true)

      - name: Initialize submodules
        run: |
          set -euo pipefail
          git config --global url."https://x-access-token:${{ github.token }}@github.com/".insteadOf "https://github.com/"
          git submodule sync --recursive
          git submodule update --init --recursive --jobs 8

      - name: Set Git identity
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Install workflow prerequisites
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            python3 \
            python-is-python3 \
            perl \
            ripgrep \
            dpkg-dev \
            debhelper \
            devscripts \
            fakeroot

      - name: Apply concurrent connections limit
        run: |
          set -euo pipefail
          new_limit="${{ steps.params.outputs.connections_limit }}"
          target_file="${{ steps.params.outputs.connections_file }}"

          if ! [[ "${new_limit}" =~ ^[0-9]+$ ]]; then
            echo "Invalid connections limit: ${new_limit}" >&2
            exit 1
          fi

          if [[ -n "${target_file}" ]]; then
            if [[ ! -f "${target_file}" ]]; then
              echo "Configured connections file not found: ${target_file}" >&2
              exit 1
            fi
            candidate_file="${target_file}"
          else
            if command -v rg >/dev/null 2>&1; then
              mapfile -t candidates < <(
                rg -l --hidden --glob '!**/.git/**' \
                  '"(max_connections|maxConnections|connections)"[[:space:]]*:[[:space:]]*20' \
                  server || true
              )
            else
              mapfile -t candidates < <(
                grep -RIlE --exclude-dir=.git \
                  '"(max_connections|maxConnections|connections)"[[:space:]]*:[[:space:]]*20' \
                  server || true
              )
            fi

            if ((${#candidates[@]} == 0)); then
              echo "Could not auto-detect a connections file in ./server." >&2
              echo "Set a fixed path in the workflow if needed." >&2
              exit 1
            fi

            if ((${#candidates[@]} > 1)); then
              echo "Multiple candidate files found. Set a fixed connections file path." >&2
              printf ' - %s\n' "${candidates[@]}" >&2
              exit 1
            fi

            candidate_file="${candidates[0]}"
          fi

          before_hash="$(sha256sum "${candidate_file}" | awk '{print $1}')"
          perl -0777 -i -pe "
            s/(\"max_connections\"\\s*:\\s*)\\d+/\\1${new_limit}/g;
            s/(\"maxConnections\"\\s*:\\s*)\\d+/\\1${new_limit}/g;
            s/(\"connections\"\\s*:\\s*)20/\\1${new_limit}/g;
          " "${candidate_file}"
          after_hash="$(sha256sum "${candidate_file}" | awk '{print $1}')"

          if [[ "${before_hash}" == "${after_hash}" ]]; then
            echo "No connection-limit change was applied in ${candidate_file}." >&2
            exit 1
          fi

          echo "Updated concurrent connections limit to ${new_limit} in ${candidate_file}"

      - name: Build project
        env:
          BUILD_COMMAND: ${{ steps.params.outputs.build_command }}
        run: |
          set -euo pipefail
          bash -lc "${BUILD_COMMAND}"

      - name: Package .deb
        env:
          PACKAGE_COMMAND: ${{ steps.params.outputs.package_command }}
        run: |
          set -euo pipefail
          bash -lc "${PACKAGE_COMMAND}"

      - name: Upload .deb artifacts
        uses: actions/upload-artifact@v4
        with:
          name: onlyoffice-deb-${{ steps.params.outputs.tag }}
          path: |
            **/*.deb
          if-no-files-found: error

      - name: Build summary
        run: |
          {
            echo "## Debian Build Summary"
            echo "- tag: ${{ steps.params.outputs.tag }}"
            echo "- connections_limit: ${{ steps.params.outputs.connections_limit }}"
            if [[ -n "${{ steps.params.outputs.connections_file }}" ]]; then
              echo "- connections_file: ${{ steps.params.outputs.connections_file }}"
            else
              echo "- connections_file: <auto-detect>"
            fi
          } >> "${GITHUB_STEP_SUMMARY}"
