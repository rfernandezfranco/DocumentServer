name: Build Debian Package On Tag

on:
  push:
    tags:
      - "*"
  repository_dispatch:
    types:
      - upstream_tag_synced
  workflow_dispatch:
    inputs:
      tag:
        description: Tag to build (optional; defaults to latest tag)
        required: false
        type: string

permissions:
  contents: read

concurrency:
  group: build-on-tag-${{ github.event.client_payload.tag || github.ref_name || github.event.inputs.tag || github.run_id }}
  cancel-in-progress: false

jobs:
  build-deb:
    runs-on: ubuntu-22.04

    steps:
      - name: Resolve build parameters
        id: params
        env:
          EVENT_NAME: ${{ github.event_name }}
          PUSH_TAG: ${{ github.ref_name }}
          DISPATCH_TAG: ${{ github.event.client_payload.tag }}
          INPUT_TAG: ${{ github.event.inputs.tag }}
          GITHUB_TOKEN: ${{ github.token }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          set -euo pipefail

          tag=""
          if [[ "${EVENT_NAME}" == "push" ]]; then
            tag="${PUSH_TAG}"
          elif [[ "${EVENT_NAME}" == "repository_dispatch" ]]; then
            tag="${DISPATCH_TAG}"
          else
            tag="${INPUT_TAG}"
          fi

          # Fallback: when event payload has no tag, resolve latest tag from repository API.
          if [[ -z "${tag}" ]]; then
            tag="$(
              GITHUB_TOKEN="${GITHUB_TOKEN}" GITHUB_REPOSITORY="${GITHUB_REPOSITORY}" \
              python3 -c 'import json,os,urllib.request; token=os.environ["GITHUB_TOKEN"]; repo=os.environ["GITHUB_REPOSITORY"]; req=urllib.request.Request(f"https://api.github.com/repos/{repo}/tags?per_page=1", headers={"Authorization": f"Bearer {token}", "Accept": "application/vnd.github+json"}); data=json.load(urllib.request.urlopen(req)); print(data[0]["name"] if data else "")'
            )"
          fi

          if [[ -z "${tag}" ]]; then
            echo "Tag could not be resolved for this run." >&2
            exit 1
          fi

          connections_limit="100"
          connections_file="server/Common/sources/constants.js"
          build_tools_repo="ONLYOFFICE/build_tools"
          build_tools_ref="$(
            GITHUB_TOKEN="${GITHUB_TOKEN}" BUILD_TOOLS_REPO="${build_tools_repo}" \
            python3 -c 'import json,os,urllib.request; token=os.environ["GITHUB_TOKEN"]; repo=os.environ["BUILD_TOOLS_REPO"]; req=urllib.request.Request(f"https://api.github.com/repos/{repo}/tags?per_page=1", headers={"Authorization": f"Bearer {token}", "Accept": "application/vnd.github+json"}); data=json.load(urllib.request.urlopen(req)); print(data[0]["name"] if data else "")'
          )"
          build_command="cd ./build_tools/tools/linux && ./automate.py server --update=0 --branch=${tag}"
          package_command="cd ./build_tools && python3 make_package.py -P linux_x86_64 -T server_community"

          if [[ -z "${build_tools_ref}" ]]; then
            echo "Could not resolve latest tag for ${build_tools_repo}" >&2
            exit 1
          fi

          echo "tag=${tag}" >> "${GITHUB_OUTPUT}"
          echo "connections_limit=${connections_limit}" >> "${GITHUB_OUTPUT}"
          echo "connections_file=${connections_file}" >> "${GITHUB_OUTPUT}"
          echo "build_tools_repo=${build_tools_repo}" >> "${GITHUB_OUTPUT}"
          echo "build_tools_ref=${build_tools_ref}" >> "${GITHUB_OUTPUT}"

          {
            echo "build_command<<EOF"
            echo "${build_command}"
            echo "EOF"
          } >> "${GITHUB_OUTPUT}"

          {
            echo "package_command<<EOF"
            echo "${package_command}"
            echo "EOF"
          } >> "${GITHUB_OUTPUT}"

      - name: Checkout tag with submodules
        uses: actions/checkout@v4
        with:
          ref: refs/tags/${{ steps.params.outputs.tag }}
          fetch-depth: 0
          submodules: false
          token: ${{ github.token }}

      - name: Configure submodules to upstream sources
        run: |
          set -euo pipefail

          while read -r key url; do
            if [[ "${url}" == ../* ]]; then
              repo="${url#../}"
              git config -f .gitmodules "${key}" "https://github.com/ONLYOFFICE/${repo}"
            fi
          done < <(git config -f .gitmodules --get-regexp '^submodule\..*\.url$' || true)

      - name: Initialize submodules
        run: |
          set -euo pipefail
          git config --global url."https://x-access-token:${{ github.token }}@github.com/".insteadOf "https://github.com/"
          git submodule sync --recursive
          git submodule update --init --recursive --jobs 8

      - name: Prepare additional repositories for local build layout
        env:
          TAG: ${{ steps.params.outputs.tag }}
        run: |
          set -euo pipefail

          required_repos=(
            "onlyoffice.github.io"
            "document-server-integration"
            "document-templates"
            "document-formats"
          )

          for repo in "${required_repos[@]}"; do
            if [[ -d "${repo}/.git" ]]; then
              echo "Repository already present: ${repo}"
              continue
            fi

            repo_url="https://github.com/ONLYOFFICE/${repo}.git"
            if git ls-remote --exit-code --tags "${repo_url}" "refs/tags/${TAG}" >/dev/null 2>&1; then
              echo "Cloning ${repo} at tag ${TAG}"
              git clone --depth=1 --branch "${TAG}" "${repo_url}" "${repo}"
            else
              echo "Tag ${TAG} not found in ${repo}. Cloning master."
              git clone --depth=1 --branch master "${repo_url}" "${repo}"
            fi
          done

      - name: Set Git identity
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Install workflow prerequisites
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            python3 \
            python-is-python3 \
            perl \
            ripgrep \
            dpkg-dev \
            debhelper \
            devscripts \
            fakeroot

      - name: Apply concurrent connections limit
        run: |
          set -euo pipefail
          new_limit="${{ steps.params.outputs.connections_limit }}"
          target_file="${{ steps.params.outputs.connections_file }}"

          if ! [[ "${new_limit}" =~ ^[0-9]+$ ]]; then
            echo "Invalid connections limit: ${new_limit}" >&2
            exit 1
          fi

          if [[ -z "${target_file}" || ! -f "${target_file}" ]]; then
            echo "Configured connections file not found: ${target_file}" >&2
            exit 1
          fi

          candidate_file="${target_file}"
          before_hash="$(sha256sum "${candidate_file}" | awk '{print $1}')"
          perl -0777 -i -pe "
            s/(\\bLICENSE_CONNECTIONS\\b\\s*=\\s*)\\d+/\\1${new_limit}/g;
            s/(exports\\.LICENSE_CONNECTIONS\\s*=\\s*)\\d+/\\1${new_limit}/g;
          " "${candidate_file}"
          after_hash="$(sha256sum "${candidate_file}" | awk '{print $1}')"

          if [[ "${before_hash}" == "${after_hash}" ]]; then
            echo "No connection-limit change was applied in ${candidate_file}." >&2
            exit 1
          fi

          echo "Updated concurrent connections limit to ${new_limit} in ${candidate_file}"

      - name: Remove conflicting global grunt binary
        run: |
          set -euo pipefail
          sudo rm -f /usr/local/bin/grunt

      - name: Checkout build_tools at latest tag
        env:
          BUILD_TOOLS_REPO: ${{ steps.params.outputs.build_tools_repo }}
          BUILD_TOOLS_REF: ${{ steps.params.outputs.build_tools_ref }}
        run: |
          set -euo pipefail
          rm -rf ./build_tools
          git init ./build_tools
          git -C ./build_tools remote add origin "https://github.com/${BUILD_TOOLS_REPO}.git"
          git -C ./build_tools fetch --depth=1 origin "${BUILD_TOOLS_REF}"
          git -C ./build_tools checkout --force FETCH_HEAD

      - name: Build project
        env:
          BUILD_COMMAND: ${{ steps.params.outputs.build_command }}
        run: |
          set -euo pipefail
          bash -lc "${BUILD_COMMAND}"

      - name: Package .deb
        env:
          PACKAGE_COMMAND: ${{ steps.params.outputs.package_command }}
        run: |
          set -euo pipefail
          bash -lc "${PACKAGE_COMMAND}"

      - name: Upload .deb artifacts
        uses: actions/upload-artifact@v4
        with:
          name: onlyoffice-deb-${{ steps.params.outputs.tag }}
          path: |
            **/*.deb
          if-no-files-found: error

      - name: Build summary
        run: |
          {
            echo "## Debian Build Summary"
            echo "- tag: ${{ steps.params.outputs.tag }}"
            echo "- connections_limit: ${{ steps.params.outputs.connections_limit }}"
            echo "- build_tools_repo: ${{ steps.params.outputs.build_tools_repo }}"
            echo "- build_tools_ref: ${{ steps.params.outputs.build_tools_ref }}"
            if [[ -n "${{ steps.params.outputs.connections_file }}" ]]; then
              echo "- connections_file: ${{ steps.params.outputs.connections_file }}"
            else
              echo "- connections_file: <auto-detect>"
            fi
          } >> "${GITHUB_STEP_SUMMARY}"
